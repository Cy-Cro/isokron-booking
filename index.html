<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Réservation - ISOKRON Studio</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --color-primary: #0A84FF;
      --color-primary-hover: #0070E0;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-900: #111827;
      --radius-md: 8px;
      --radius-lg: 12px;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    
    .booking-widget {
      width: 100%;
      max-width: 800px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    /* Header */
    .booking-widget__header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .booking-widget__back {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: transparent;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .booking-widget__back:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }
    
    .booking-widget__title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-900);
    }
    
    /* Content */
    .booking-widget__content {
      padding: 24px;
    }
    
    /* Section */
    .booking-section {
      margin-bottom: 32px;
    }
    
    .booking-section:last-child {
      margin-bottom: 0;
    }
    
    .booking-section__title {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }
    
    /* Prestation types */
    .booking-types {
      display: flex;
      gap: 12px;
    }
    
    @media (max-width: 600px) {
      .booking-types {
        flex-direction: column;
      }
    }
    
    .booking-type {
      flex: 1;
      padding: 16px 20px;
      background: #fff;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }
    
    .booking-type:hover {
      border-color: var(--gray-300);
      transform: translateY(-1px);
    }
    
    .booking-type.selected {
      border-color: var(--color-primary);
      background: rgba(10, 132, 255, 0.02);
    }
    
    .booking-type__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .booking-type__name {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .booking-type__duration {
      font-size: 12px;
      color: var(--gray-500);
      background: var(--gray-100);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .booking-type__desc {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .booking-type__price {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .booking-type__price span {
      font-size: 13px;
      font-weight: 400;
      color: var(--gray-500);
    }
    
    /* Calendar wrapper */
    .booking-calendar-wrapper {
      display: flex;
      gap: 24px;
    }
    
    @media (max-width: 600px) {
      .booking-calendar-wrapper {
        flex-direction: column;
      }
    }
    
    /* Calendar */
    .booking-calendar {
      flex: 1;
      min-width: 280px;
    }
    
    .booking-calendar__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .booking-calendar__title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .booking-calendar__nav {
      display: flex;
      gap: 8px;
    }
    
    .booking-calendar__nav button {
      width: 32px;
      height: 32px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      color: var(--gray-600);
    }
    
    .booking-calendar__nav button:hover:not(:disabled) {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }
    
    .booking-calendar__nav button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .booking-calendar__weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    
    .booking-calendar__weekdays span {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-400);
      padding: 8px 0;
      text-transform: uppercase;
    }
    
    .booking-calendar__days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    
    .booking-calendar__day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      background: transparent;
      color: var(--gray-700);
    }
    
    .booking-calendar__day:hover:not(.disabled):not(.selected):not(.other-month) {
      background: var(--gray-100);
    }
    
    .booking-calendar__day.today {
      font-weight: 600;
    }
    
    .booking-calendar__day.available {
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 500;
    }
    
    .booking-calendar__day.available:hover {
      background: #bae6fd;
    }
    
    .booking-calendar__day.selected {
      background: var(--color-primary);
      color: #fff;
    }
    
    .booking-calendar__day.disabled {
      color: var(--gray-300);
      cursor: not-allowed;
    }
    
    .booking-calendar__day.other-month {
      color: var(--gray-300);
      cursor: default;
    }
    
    /* Slots */
    .booking-slots {
      min-width: 200px;
      background: var(--gray-50);
      border-radius: var(--radius-lg);
      padding: 20px;
    }
    
    .booking-slots__empty {
      text-align: center;
      color: var(--gray-400);
      font-size: 14px;
      padding: 40px 16px;
    }
    
    .booking-slots__date {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 12px;
      text-transform: capitalize;
    }
    
    .booking-slots__list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .booking-slot {
      padding: 12px 16px;
      background: #fff;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      transition: all 0.15s ease;
      text-align: center;
    }
    
    .booking-slot:hover {
      border-color: var(--color-primary);
    }
    
    .booking-slot.selected {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: #fff;
    }
    
    /* CTA Button */
    .booking-widget__cta {
      width: 100%;
      margin-top: 16px;
      padding: 14px 24px;
      background: var(--gray-900);
      color: #fff;
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .booking-widget__cta:hover {
      background: #000;
    }
    
    .booking-widget__cta:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
    }
    
    .booking-widget__cta--primary {
      background: var(--color-primary);
    }
    
    .booking-widget__cta--primary:hover {
      background: var(--color-primary-hover);
    }
    
    /* Form */
    .booking-form-group {
      margin-bottom: 16px;
    }
    
    .booking-form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 6px;
    }
    
    .booking-form-group input,
    .booking-form-group textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 14px;
      transition: all 0.15s ease;
      background: #fff;
    }
    
    .booking-form-group input:focus,
    .booking-form-group textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
    }
    
    .booking-form-group input::placeholder,
    .booking-form-group textarea::placeholder {
      color: var(--gray-400);
    }
    
    .booking-form-group textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }
    
    .booking-form-row {
      display: flex;
      gap: 12px;
    }
    
    .booking-form-row .booking-form-group {
      flex: 1;
    }
    
    /* Summary */
    .booking-summary {
      background: var(--gray-50);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .booking-summary__row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .booking-summary__row:last-child {
      margin-bottom: 0;
    }
    
    .booking-summary__label {
      color: var(--gray-500);
    }
    
    .booking-summary__value {
      font-weight: 500;
      color: var(--gray-900);
    }
    
    .booking-summary__divider {
      height: 1px;
      background: var(--gray-200);
      margin: 16px 0;
    }
    
    .booking-summary__row--highlight {
      padding-top: 12px;
      border-top: 1px solid var(--gray-200);
      font-weight: 600;
    }
    
    .booking-summary__row--highlight .booking-summary__value {
      color: var(--color-primary);
      font-size: 16px;
    }
    
    /* Legal */
    .booking-legal {
      font-size: 12px;
      color: var(--gray-500);
      text-align: center;
      margin-bottom: 16px;
    }
    
    .booking-legal a {
      color: var(--gray-700);
      text-decoration: underline;
    }
    
    /* Error */
    .booking-widget__error {
      background: #fef2f2;
      color: #b91c1c;
      padding: 12px 16px;
      margin: 0 24px 16px 24px;
      border-radius: var(--radius-md);
      font-size: 14px;
      display: none;
    }
    
    .booking-widget__error.visible {
      display: block;
    }
    
    /* Loading */
    .booking-widget__loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 24px;
      gap: 16px;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Views */
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="booking-widget">
    <!-- Error message -->
    <div id="error" class="booking-widget__error"></div>
    
    <!-- Loading -->
    <div id="loading" class="booking-widget__loading" style="display: none;">
      <div class="spinner"></div>
      <span>Chargement...</span>
    </div>
    
    <!-- STEP 1: Calendar -->
    <div id="view-calendar" class="view active">
      <div class="booking-widget__header">
        <h2 class="booking-widget__title">Réserver une séance</h2>
      </div>
      
      <div class="booking-widget__content">
        <!-- Prestation types -->
        <section class="booking-section">
          <h3 class="booking-section__title">Choisissez votre formule</h3>
          <div class="booking-types" id="prestation-types"></div>
        </section>
        
        <!-- Calendar + Slots -->
        <section class="booking-section">
          <h3 class="booking-section__title">Sélectionnez une date</h3>
          <div class="booking-calendar-wrapper">
            <div class="booking-calendar">
              <div class="booking-calendar__header">
                <span class="booking-calendar__title" id="calendar-month"></span>
                <div class="booking-calendar__nav">
                  <button onclick="prevMonth()" id="btn-prev">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                  </button>
                  <button onclick="nextMonth()" id="btn-next">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                  </button>
                </div>
              </div>
              <div class="booking-calendar__weekdays">
                <span>LUN</span><span>MAR</span><span>MER</span><span>JEU</span><span>VEN</span><span>SAM</span><span>DIM</span>
              </div>
              <div class="booking-calendar__days" id="calendar-days"></div>
            </div>
            
            <div class="booking-slots" id="slots-panel">
              <div class="booking-slots__empty">Sélectionnez une date</div>
            </div>
          </div>
        </section>
      </div>
    </div>
    
    <!-- STEP 2: Form -->
    <div id="view-form" class="view">
      <div class="booking-widget__header">
        <button class="booking-widget__back" onclick="showView('calendar')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
          <span>Retour</span>
        </button>
        <h2 class="booking-widget__title">Vos coordonnées</h2>
      </div>
      
      <div class="booking-widget__content">
        <form id="booking-form" onsubmit="submitForm(event)">
          <div class="booking-form-row">
            <div class="booking-form-group">
              <label>Prénom *</label>
              <input type="text" id="firstName" placeholder="Jean" required>
            </div>
            <div class="booking-form-group">
              <label>Nom *</label>
              <input type="text" id="lastName" placeholder="Dupont" required>
            </div>
          </div>
          
          <div class="booking-form-group">
            <label>Email *</label>
            <input type="email" id="email" placeholder="jean@exemple.com" required>
          </div>
          
          <div class="booking-form-group">
            <label>Téléphone</label>
            <input type="tel" id="phone" placeholder="06 12 34 56 78">
          </div>
          
          <div class="booking-form-group">
            <label>Adresse du shooting *</label>
            <input type="text" id="address" placeholder="123 rue de la Photo" required>
          </div>
          
          <div class="booking-form-row">
            <div class="booking-form-group">
              <label>Code postal *</label>
              <input type="text" id="postalCode" placeholder="75001" required>
            </div>
            <div class="booking-form-group">
              <label>Ville *</label>
              <input type="text" id="city" placeholder="Paris" required>
            </div>
          </div>
          
          <div class="booking-form-group">
            <label>Notes (accès, parking...)</label>
            <textarea id="notes" placeholder="Informations utiles pour le jour J"></textarea>
          </div>
          
          <div class="booking-summary">
            <div class="booking-summary__row">
              <span class="booking-summary__label">Prestation</span>
              <span class="booking-summary__value" id="summary-type"></span>
            </div>
            <div class="booking-summary__row">
              <span class="booking-summary__label">Date</span>
              <span class="booking-summary__value" id="summary-date"></span>
            </div>
            <div class="booking-summary__row">
              <span class="booking-summary__label">Créneau</span>
              <span class="booking-summary__value" id="summary-slot"></span>
            </div>
            <div class="booking-summary__divider"></div>
            <div class="booking-summary__row">
              <span class="booking-summary__label">Prix total</span>
              <span class="booking-summary__value" id="summary-total"></span>
            </div>
            <div class="booking-summary__row booking-summary__row--highlight">
              <span class="booking-summary__label">Acompte à payer</span>
              <span class="booking-summary__value" id="summary-deposit"></span>
            </div>
          </div>
          
          <p class="booking-legal">
            En continuant, vous acceptez nos <a href="https://isokron.fr/cgv" target="_blank">CGV</a> 
            et notre <a href="https://isokron.fr/confidentialite" target="_blank">politique de confidentialité</a>.
          </p>
          
          <button type="submit" class="booking-widget__cta booking-widget__cta--primary" id="submit-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            <span id="submit-text">Payer l'acompte</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ================================================
    // CONFIGURATION SUPABASE
    // ================================================
    const SUPABASE_URL = "https://eenyygeizwabcfnotcdl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlbnl5Z2VpendhYmNmbm90Y2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzE4MDIsImV4cCI6MjA4MDgwNzgwMn0.aSif5DIk1Bv8wdJWDofHNmuscNbi5-B2NlGEmFhVFoY";
    const API_BASE = `${SUPABASE_URL}/functions/v1`;

    // ================================================
    // STATE
    // ================================================
    let state = {
      prestationTypes: [],
      selectedType: null,
      slots: [],
      selectedDate: null,
      selectedSlot: null,
      currentMonth: new Date()
    };

    // ================================================
    // INITIALIZATION
    // ================================================
    document.addEventListener('DOMContentLoaded', async () => {
      await loadPrestationTypes();
    });

    // ================================================
    // DATA LOADING
    // ================================================
    async function loadPrestationTypes() {
      showLoading(true);
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/prestation_types?is_active=eq.true&order=price.asc`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );
        const types = await response.json();
        
        if (types && types.length > 0) {
          state.prestationTypes = types;
          state.selectedType = types[0];
          renderPrestationTypes();
          await loadAvailability();
        }
      } catch (err) {
        showError("Impossible de charger les formules.");
        console.error(err);
      } finally {
        showLoading(false);
      }
    }

    async function loadAvailability() {
      if (!state.selectedType) return;
      
      try {
        const response = await fetch(
          `${API_BASE}/get-availability?type=${state.selectedType.slug}&weeks=8`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        state.slots = data.slots || [];
        renderCalendar();
      } catch (err) {
        console.error('Erreur disponibilités:', err);
      }
    }

    // ================================================
    // RENDERERS
    // ================================================
    function renderPrestationTypes() {
      const container = document.getElementById('prestation-types');
      container.innerHTML = state.prestationTypes.map(type => {
        const deposit = Math.round(type.price * (type.deposit_percent / 100));
        const isSelected = state.selectedType?.id === type.id;
        return `
          <button class="booking-type ${isSelected ? 'selected' : ''}" onclick="selectType('${type.id}')">
            <div class="booking-type__header">
              <span class="booking-type__name">${type.name}</span>
              <span class="booking-type__duration">${type.duration_hours}h</span>
            </div>
            <p class="booking-type__desc">${type.description || ''}</p>
            <div class="booking-type__price">
              ${type.price} € <span>(acompte ${deposit} €)</span>
            </div>
          </button>
        `;
      }).join('');
    }

    function renderCalendar() {
      const year = state.currentMonth.getFullYear();
      const month = state.currentMonth.getMonth();
      const monthNames = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 
                          'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
      
      document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
      
      const availableDates = new Set(state.slots.map(s => s.date));
      const container = document.getElementById('calendar-days');
      container.innerHTML = '';
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = (firstDay.getDay() + 6) % 7;
      
      // Previous month days
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        container.appendChild(createDayButton(prevMonthLastDay - i, true, false, false));
      }
      
      // Current month days
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        const dateStr = formatDateISO(date);
        const isAvailable = availableDates.has(dateStr);
        const isPast = date < today;
        const isToday = date.getTime() === today.getTime();
        const isSelected = state.selectedDate === dateStr;
        
        const btn = createDayButton(day, false, isAvailable && !isPast, isPast);
        if (isToday) btn.classList.add('today');
        if (isSelected) btn.classList.add('selected');
        if (isAvailable && !isPast) {
          btn.onclick = () => selectDate(dateStr);
        }
        container.appendChild(btn);
      }
      
      // Next month days
      const totalCells = container.children.length;
      const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells;
      for (let day = 1; day <= remainingCells; day++) {
        container.appendChild(createDayButton(day, true, false, false));
      }
      
      // Nav buttons
      const minDate = new Date();
      document.getElementById('btn-prev').disabled = 
        state.currentMonth <= new Date(minDate.getFullYear(), minDate.getMonth(), 1);
      
      renderSlots();
    }

    function createDayButton(day, isOtherMonth, isAvailable, isPast) {
      const btn = document.createElement('button');
      btn.className = 'booking-calendar__day';
      btn.textContent = day;
      btn.type = 'button';
      if (isOtherMonth) btn.classList.add('other-month', 'disabled');
      if (isAvailable) btn.classList.add('available');
      if (isPast && !isOtherMonth) btn.classList.add('disabled');
      return btn;
    }

    function renderSlots() {
      const container = document.getElementById('slots-panel');
      
      if (!state.selectedDate) {
        container.innerHTML = '<div class="booking-slots__empty">Sélectionnez une date</div>';
        return;
      }
      
      const dateSlots = state.slots.filter(s => s.date === state.selectedDate);
      
      if (dateSlots.length === 0) {
        container.innerHTML = '<div class="booking-slots__empty">Aucun créneau disponible</div>';
        return;
      }
      
      // Parser la date sans décalage UTC
      const [year, month, day] = state.selectedDate.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      const dateLabel = date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
      });
      
      let html = `<div class="booking-slots__date">${dateLabel}</div><div class="booking-slots__list">`;
      
      dateSlots.forEach(slot => {
        const isSelected = state.selectedSlot?.startTime === slot.startTime && 
                          state.selectedSlot?.date === slot.date;
        const label = getSlotLabel(slot);
        html += `
          <button type="button" class="booking-slot ${isSelected ? 'selected' : ''}" 
                  onclick='selectSlot(${JSON.stringify(slot)})'>
            ${label}
          </button>
        `;
      });
      
      html += '</div>';
      
      if (state.selectedSlot) {
        html += `<button type="button" class="booking-widget__cta" onclick="showView('form')">Continuer</button>`;
      }
      
      container.innerHTML = html;
    }

    // ================================================
    // HANDLERS
    // ================================================
    function selectType(typeId) {
      state.selectedType = state.prestationTypes.find(t => t.id === typeId);
      state.selectedDate = null;
      state.selectedSlot = null;
      renderPrestationTypes();
      loadAvailability();
    }

    function selectDate(dateStr) {
      state.selectedDate = dateStr;
      state.selectedSlot = null;
      renderCalendar();
    }

    function selectSlot(slot) {
      state.selectedSlot = slot;
      renderSlots();
    }

    function prevMonth() {
      state.currentMonth.setMonth(state.currentMonth.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      state.currentMonth.setMonth(state.currentMonth.getMonth() + 1);
      renderCalendar();
    }

    function showView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(`view-${viewName}`).classList.add('active');
      
      if (viewName === 'form') {
        updateFormSummary();
      }
    }

    function updateFormSummary() {
      const type = state.selectedType;
      const slot = state.selectedSlot;
      const deposit = Math.round(type.price * (type.deposit_percent / 100));
      
      // Parser la date sans décalage UTC
      const [year, month, day] = slot.date.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      
      document.getElementById('summary-type').textContent = type.name;
      document.getElementById('summary-date').textContent = date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
      });
      document.getElementById('summary-slot').textContent = getSlotLabel(slot);
      document.getElementById('summary-total').textContent = `${type.price} €`;
      document.getElementById('summary-deposit').textContent = `${deposit} €`;
      document.getElementById('submit-text').textContent = `Payer ${deposit} €`;
    }

    async function submitForm(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      document.getElementById('submit-text').textContent = 'Chargement...';
      
      const payload = {
        prestationType: state.selectedType.slug,
        date: state.selectedSlot.date,
        startTime: state.selectedSlot.startTime,
        endTime: state.selectedSlot.endTime,
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
        postalCode: document.getElementById('postalCode').value.trim(),
        city: document.getElementById('city').value.trim(),
        notes: document.getElementById('notes').value.trim()
      };
      
      try {
        const response = await fetch(`${API_BASE}/create-booking`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        if (data.checkoutUrl) {
          window.location.href = data.checkoutUrl;
        }
      } catch (err) {
        showError(err.message || "Une erreur est survenue.");
        const deposit = Math.round(state.selectedType.price * (state.selectedType.deposit_percent / 100));
        submitBtn.disabled = false;
        document.getElementById('submit-text').textContent = `Payer ${deposit} €`;
      }
    }

    // ================================================
    // HELPERS
    // ================================================
    function getSlotLabel(slot) {
      if (state.selectedType?.slug === 'journee') {
        return 'Journée (9h - 16h)';
      }
      return slot.startTime === '09:00' ? 'Matin (9h - 12h)' : 'Après-midi (13h - 16h)';
    }

    function formatDateISO(date) {
      // Formater sans décalage UTC
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
      document.getElementById('view-calendar').style.display = show ? 'none' : 'block';
    }

    function showError(message) {
      const el = document.getElementById('error');
      el.textContent = message;
      el.classList.add('visible');
      setTimeout(() => el.classList.remove('visible'), 5000);
    }
  </script>
</body>
</html>
