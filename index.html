<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Réservation - ISOKRON Studio</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.47;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
    }
    
    .bw { width: 100%; max-width: 680px; }
    
    /* Back button */
    .bw__back {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      margin-left: -0.75rem;
      margin-bottom: 0.5rem;
      background: none;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      color: #0071e3;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .bw__back:hover { background: rgba(0, 113, 227, 0.08); }
    .bw__back svg { width: 18px; height: 18px; }
    
    /* Header */
    .bw__header { margin-bottom: 1.5rem; }
    .bw__title { font-size: 28px; font-weight: 600; color: #1d1d1f; margin: 0; }
    
    /* Error */
    .bw__error {
      background: #fff0f0;
      color: #de071c;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 1.5rem;
      display: none;
    }
    .bw__error.visible { display: block; }
    
    /* Content */
    .bw__content { display: flex; flex-direction: column; gap: 2rem; }
    
    /* Section */
    .bw__section { display: flex; flex-direction: column; gap: 1rem; }
    .bw__section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #86868b;
      margin: 0;
    }
    
    /* Formulas */
    .bw__formulas { display: flex; gap: 0.75rem; }
    @media (max-width: 600px) { .bw__formulas { flex-direction: column; } }
    
    .bw__formula {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem 1.25rem;
      background: #fff;
      border: 1.5px solid #d2d2d7;
      border-radius: 12px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s ease;
    }
    
    .bw__formula:hover:not(.bw__formula--selected) { border-color: #86868b; }
    .bw__formula--selected { border-color: #0071e3; background: #f5f8ff; }
    
    .bw__formula-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    
    .bw__formula-name { font-size: 15px; font-weight: 600; color: #1d1d1f; }
    .bw__formula-duration { font-size: 13px; color: #86868b; }
    .bw__formula-desc { font-size: 13px; color: #86868b; line-height: 1.4; margin-bottom: 0.75rem; }
    
    .bw__formula-price {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-top: auto;
      padding-top: 0.75rem;
      border-top: 1px solid #f5f5f7;
    }
    
    .bw__formula-amount { font-size: 15px; font-weight: 600; color: #1d1d1f; }
    .bw__formula-deposit { font-size: 12px; color: #86868b; }
    
    /* Scheduling */
    .bw__scheduling {
      display: grid;
      grid-template-columns: 1fr 160px;
      gap: 2rem;
      background: #fff;
      border-radius: 14px;
      padding: 1.5rem;
      border: 1px solid #d2d2d7;
      align-items: start;
    }
    
    @media (max-width: 600px) {
      .bw__scheduling { grid-template-columns: 1fr; gap: 1.5rem; }
      .bw__slots { padding-top: 1.25rem; border-top: 1px solid #e5e5e5; }
    }
    
    /* Calendar */
    .bw__calendar { position: relative; }
    .bw__calendar__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .bw__calendar__title { font-size: 15px; font-weight: 600; color: #1d1d1f; }
    .bw__calendar__nav { display: flex; gap: 0.25rem; }
    
    .bw__calendar__nav button {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      background: none;
      border: 1px solid #d2d2d7;
      border-radius: 6px;
      color: #86868b;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .bw__calendar__nav button:hover:not(:disabled) { background: #f5f5f7; border-color: #86868b; }
    .bw__calendar__nav button:disabled { opacity: 0.3; cursor: not-allowed; }
    .bw__calendar__nav button svg { width: 16px; height: 16px; }
    
    .bw__calendar__weekdays { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 0.5rem; }
    .bw__calendar__weekdays span { text-align: center; font-size: 11px; font-weight: 600; color: #86868b; padding: 0.5rem 0; }
    
    .bw__calendar__days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    
    .bw__calendar__day {
      aspect-ratio: 1;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
      border-radius: 10px;
      border: none;
      background: none;
      color: #1d1d1f;
      cursor: pointer;
      transition: all 0.1s ease;
    }
    
    .bw__calendar__day:hover:not(:disabled):not(.selected) { background: #f5f5f7; }
    .bw__calendar__day.today { font-weight: 600; }
    .bw__calendar__day.available { background: #e8f4fd; color: #0071e3; font-weight: 500; }
    .bw__calendar__day.available:hover:not(.selected) { background: #d4ebfc; }
    .bw__calendar__day.selected { background: #0071e3; color: #fff; font-weight: 600; }
    .bw__calendar__day.disabled { color: #d2d2d7; cursor: not-allowed; }
    .bw__calendar__day.other { color: #d2d2d7; }
    
    /* Slots */
    .bw__slots { display: flex; flex-direction: column; }
    .bw__slots-empty { font-size: 13px; color: #86868b; text-align: center; padding: 1.5rem 0.5rem; }
    .bw__slots-date { font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 0.75rem; text-transform: capitalize; }
    .bw__slots-list { display: flex; flex-direction: column; gap: 0.375rem; }
    
    .bw__slot {
      display: flex; justify-content: center; align-items: center;
      padding: 0.5rem 0.75rem;
      background: #f5f5f7;
      border: 1.5px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 36px;
      text-align: center;
    }
    
    .bw__slot:hover:not(.bw__slot--selected):not(.bw__slot--continue) { border-color: #0071e3; background: #f0f7ff; }
    .bw__slot--selected { background: #0071e3; border-color: #0071e3; }
    .bw__slot-label { font-size: 13px; font-weight: 500; color: #1d1d1f; }
    .bw__slot--selected .bw__slot-label { color: #fff; }
    
    .bw__slot--continue { background: #0071e3; border-color: #0071e3; margin-top: 0.375rem; gap: 0.25rem; }
    .bw__slot--continue:hover { background: #0077ed; border-color: #0077ed; }
    .bw__slot--continue .bw__slot-label { color: #fff; font-weight: 600; }
    .bw__slot--continue svg { color: #fff; width: 14px; height: 14px; }
    
    /* Form */
    .bw__form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: #fff;
      border: 1px solid #d2d2d7;
      border-radius: 14px;
      padding: 1.25rem;
    }
    
    .bw__field { display: flex; flex-direction: column; gap: 0.375rem; }
    .bw__field label { font-size: 13px; font-weight: 500; color: #1d1d1f; }
    .bw__field label span { font-weight: 400; color: #86868b; }
    
    .bw__field input,
    .bw__field textarea {
      padding: 0.625rem 0.875rem;
      border: 1px solid #d2d2d7;
      border-radius: 10px;
      font-size: 15px;
      color: #1d1d1f;
      background: #fff;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    
    .bw__field input:focus,
    .bw__field textarea:focus { outline: none; border-color: #0071e3; box-shadow: 0 0 0 3px rgba(0,113,227,0.1); }
    .bw__field input.invalid,
    .bw__field textarea.invalid { border-color: #de071c; }
    .bw__field input.invalid:focus,
    .bw__field textarea.invalid:focus { border-color: #de071c; box-shadow: 0 0 0 3px rgba(222,7,28,0.1); }
    .bw__field input::placeholder,
    .bw__field textarea::placeholder { color: #86868b; }
    .bw__field textarea { resize: vertical; min-height: 80px; }
    
    .bw__field-row { display: flex; gap: 0.75rem; }
    .bw__field-row .bw__field { flex: 1; }
    
    /* Summary */
    .bw__summary { background: #fff; border: 1px solid #d2d2d7; border-radius: 14px; padding: 1.25rem; }
    .bw__summary-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 0.625rem 0; font-size: 14px; }
    .bw__summary-row > span:first-child { color: #86868b; }
    .bw__summary-row > span:last-child { color: #1d1d1f; font-weight: 500; text-align: right; max-width: 60%; }
    .bw__summary-divider { height: 1px; background: #d2d2d7; margin: 0.5rem 0; }
    .bw__summary-row--highlight > span:last-child { font-size: 17px; font-weight: 600; color: #0071e3; }
    
    /* Legal */
    .bw__legal { font-size: 12px; color: #86868b; text-align: center; margin: 1.5rem 0 1rem; line-height: 1.5; }
    .bw__legal a { color: #0071e3; text-decoration: none; }
    .bw__legal a:hover { text-decoration: underline; }
    
    /* CTA */
    .bw__cta {
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      width: 100%;
      padding: 0.875rem 1.5rem;
      margin-top: 1.5rem;
      background: #1d1d1f;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .bw__cta:hover:not(:disabled) { background: #000; }
    .bw__cta:disabled { background: #86868b; cursor: not-allowed; }
    .bw__cta--primary { background: #0071e3; }
    .bw__cta--primary:hover:not(:disabled) { background: #0077ed; }
    .bw__cta svg { width: 18px; height: 18px; }
    
    /* Loading */
    .bw__loading { display: none; justify-content: center; align-items: center; min-height: 400px; }
    .bw__loading.visible { display: flex; }
    .bw__spinner { width: 24px; height: 24px; border: 2px solid #d2d2d7; border-top-color: #0071e3; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Views */
    .view { display: none; }
    .view.active { display: block; }
  </style>
</head>
<body>
  <div class="bw">
    <!-- Error -->
    <div id="error" class="bw__error"></div>
    
    <!-- Loading -->
    <div id="loading" class="bw__loading">
      <div class="bw__spinner"></div>
    </div>
    
    <!-- ============================================
         ÉTAPE 1: Calendrier
         ============================================ -->
    <div id="view-calendar" class="view active">
      <header class="bw__header">
        <h1 class="bw__title">Réserver une séance</h1>
      </header>
      
      <div class="bw__content">
        <section class="bw__section">
          <h2 class="bw__section-title">Choisissez votre formule</h2>
          <div class="bw__formulas" id="formulas"></div>
        </section>
        
        <section class="bw__section">
          <h2 class="bw__section-title">Sélectionnez une date</h2>
          <div class="bw__scheduling">
            <div class="bw__calendar">
              <div class="bw__calendar__header">
                <span class="bw__calendar__title" id="calendar-month"></span>
                <div class="bw__calendar__nav">
                  <button type="button" id="btn-prev">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                  </button>
                  <button type="button" id="btn-next">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                  </button>
                </div>
              </div>
              <div class="bw__calendar__weekdays">
                <span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span><span>D</span>
              </div>
              <div class="bw__calendar__days" id="calendar-days"></div>
            </div>
            
            <div class="bw__slots" id="slots-panel">
              <p class="bw__slots-empty">Sélectionnez une date</p>
            </div>
          </div>
        </section>
      </div>
    </div>
    
    <!-- ============================================
         ÉTAPE 2: Vos informations (coordonnées + adresse)
         ============================================ -->
    <div id="view-info" class="view">
      <button type="button" class="bw__back" id="btn-back-info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        <span>Précédent</span>
      </button>
      
      <header class="bw__header">
        <h1 class="bw__title">Vos informations</h1>
      </header>
      
      <div class="bw__content">
        <!-- Coordonnées -->
        <section class="bw__section">
          <h2 class="bw__section-title">Coordonnées</h2>
          <div class="bw__form">
            <div class="bw__field-row">
              <div class="bw__field">
                <label>Prénom *</label>
                <input type="text" id="firstName" placeholder="Jean" autocomplete="given-name" autocorrect="on" autocapitalize="words">
              </div>
              <div class="bw__field">
                <label>Nom *</label>
                <input type="text" id="lastName" placeholder="Dupont" autocomplete="family-name" autocorrect="on" autocapitalize="words">
              </div>
            </div>
            <div class="bw__field">
              <label>Email *</label>
              <input type="email" id="email" placeholder="jean@exemple.com" autocomplete="email" autocorrect="on" autocapitalize="none">
            </div>
            <div class="bw__field">
              <label>Téléphone <span>(optionnel)</span></label>
              <input type="tel" id="phone" placeholder="06 12 34 56 78" autocomplete="tel" autocorrect="on">
            </div>
          </div>
        </section>
        
        <!-- Adresse du shooting -->
        <section class="bw__section">
          <h2 class="bw__section-title">Adresse du shooting</h2>
          <div class="bw__form">
            <div class="bw__field">
              <label>Adresse *</label>
              <input type="text" id="address" placeholder="123 rue de la Photo" autocomplete="street-address" autocorrect="on">
            </div>
            <div class="bw__field-row">
              <div class="bw__field">
                <label>Code postal *</label>
                <input type="text" id="postalCode" placeholder="75001" autocomplete="postal-code" autocorrect="on">
              </div>
              <div class="bw__field">
                <label>Ville *</label>
                <input type="text" id="city" placeholder="Paris" autocomplete="address-level2" autocorrect="on" autocapitalize="words">
              </div>
            </div>
            <div class="bw__field">
              <label>Notes <span>(optionnel)</span></label>
              <textarea id="notes" placeholder="Accès, parking, code d'entrée..." autocorrect="on"></textarea>
            </div>
          </div>
        </section>
        
        <button type="button" class="bw__cta bw__cta--primary" id="btn-to-confirm">
          Continuer
        </button>
      </div>
    </div>
    
    <!-- ============================================
         ÉTAPE 3: Confirmation
         ============================================ -->
    <div id="view-confirm" class="view">
      <button type="button" class="bw__back" id="btn-back-confirm">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        <span>Précédent</span>
      </button>
      
      <header class="bw__header">
        <h1 class="bw__title">Confirmation</h1>
      </header>
      
      <div class="bw__content">
        <section class="bw__section">
          <h2 class="bw__section-title">Récapitulatif</h2>
          
          <div class="bw__summary">
            <div class="bw__summary-row">
              <span>Prestation</span>
              <span id="summary-type"></span>
            </div>
            <div class="bw__summary-row">
              <span>Date</span>
              <span id="summary-date"></span>
            </div>
            <div class="bw__summary-row">
              <span>Créneau</span>
              <span id="summary-slot"></span>
            </div>
            <div class="bw__summary-row">
              <span>Lieu</span>
              <span id="summary-location"></span>
            </div>
            
            <div class="bw__summary-divider"></div>
            
            <div class="bw__summary-row">
              <span>Prix total</span>
              <span id="summary-total"></span>
            </div>
            <div class="bw__summary-row bw__summary-row--highlight">
              <span>Acompte de réservation</span>
              <span id="summary-deposit"></span>
            </div>
          </div>
          
          <p class="bw__legal">
            En continuant, vous acceptez nos <a href="https://isokron.fr/cgv" target="_blank">CGV</a> 
            et notre <a href="https://isokron.fr/confidentialite" target="_blank">politique de confidentialité</a>.
          </p>
          
          <button type="button" class="bw__cta bw__cta--primary" id="btn-submit">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            <span id="submit-text">Payer l'acompte</span>
          </button>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ================================================
    // CONFIG
    // ================================================
    const SUPABASE_URL = "https://eenyygeizwabcfnotcdl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlbnl5Z2VpendhYmNmbm90Y2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzE4MDIsImV4cCI6MjA4MDgwNzgwMn0.aSif5DIk1Bv8wdJWDofHNmuscNbi5-B2NlGEmFhVFoY";
    const API_BASE = `${SUPABASE_URL}/functions/v1`;

    // ================================================
    // STATE
    // ================================================
    const state = {
      prestationTypes: [],
      selectedType: null,
      slots: [],
      selectedDate: null,
      selectedSlot: null,
      currentMonth: new Date()
    };
    
    const availabilityCache = {};

    // ================================================
    // INIT
    // ================================================
    document.addEventListener('DOMContentLoaded', function() {
      // Navigation buttons
      document.getElementById('btn-prev').addEventListener('click', prevMonth);
      document.getElementById('btn-next').addEventListener('click', nextMonth);
      document.getElementById('btn-back-info').addEventListener('click', function() { goToView('calendar'); });
      document.getElementById('btn-back-confirm').addEventListener('click', function() { goToView('info'); });
      document.getElementById('btn-to-confirm').addEventListener('click', goToConfirm);
      document.getElementById('btn-submit').addEventListener('click', submitBooking);
      
      // Clear error styling on input
      var fields = ['firstName', 'lastName', 'email', 'address', 'postalCode', 'city'];
      fields.forEach(function(id) {
        document.getElementById(id).addEventListener('input', function() {
          this.classList.remove('invalid');
        });
      });
      
      // Load data
      loadPrestationTypes();
    });

    // ================================================
    // NAVIGATION
    // ================================================
    function goToView(viewName) {
      document.querySelectorAll('.view').forEach(function(v) {
        v.classList.remove('active');
      });
      var target = document.getElementById('view-' + viewName);
      if (target) {
        target.classList.add('active');
        window.scrollTo(0, 0);
      }
    }
    
    function goToInfo() {
      goToView('info');
    }
    
    function goToConfirm() {
      // Réinitialiser les erreurs visuelles
      clearFieldErrors();
      
      var firstName = document.getElementById('firstName').value.trim();
      var lastName = document.getElementById('lastName').value.trim();
      var email = document.getElementById('email').value.trim();
      var address = document.getElementById('address').value.trim();
      var postalCode = document.getElementById('postalCode').value.trim();
      var city = document.getElementById('city').value.trim();
      
      // Validation des champs requis
      if (!firstName) {
        showFieldError('firstName', "Veuillez renseigner votre prénom");
        return;
      }
      
      if (!lastName) {
        showFieldError('lastName', "Veuillez renseigner votre nom");
        return;
      }
      
      if (!email) {
        showFieldError('email', "Veuillez renseigner votre email");
        return;
      }
      
      // Validation email
      if (!isValidEmail(email)) {
        showFieldError('email', "Veuillez renseigner un email valide");
        return;
      }
      
      if (!address) {
        showFieldError('address', "Veuillez renseigner l'adresse du shooting");
        return;
      }
      
      if (!postalCode) {
        showFieldError('postalCode', "Veuillez renseigner le code postal");
        return;
      }
      
      if (!city) {
        showFieldError('city', "Veuillez renseigner la ville");
        return;
      }
      
      updateSummary();
      goToView('confirm');
    }
    
    function isValidEmail(email) {
      var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
    
    function showFieldError(fieldId, message) {
      var field = document.getElementById(fieldId);
      field.classList.add('invalid');
      field.focus();
      showError(message);
    }
    
    function clearFieldErrors() {
      var fields = ['firstName', 'lastName', 'email', 'address', 'postalCode', 'city'];
      fields.forEach(function(id) {
        document.getElementById(id).classList.remove('invalid');
      });
    }

    // ================================================
    // DATA LOADING
    // ================================================
    async function loadPrestationTypes() {
      showLoading(true);
      try {
        var res = await fetch(
          SUPABASE_URL + '/rest/v1/prestation_types?is_active=eq.true&order=price.asc',
          { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY } }
        );
        var types = await res.json();
        if (types && types.length) {
          state.prestationTypes = types;
          state.selectedType = types[0];
          renderFormulas();
          await loadAllAvailabilities();
        }
      } catch (err) {
        showError("Impossible de charger les formules.");
      } finally {
        showLoading(false);
      }
    }

    async function loadAllAvailabilities() {
      var promises = state.prestationTypes.map(async function(type) {
        try {
          var res = await fetch(
            API_BASE + '/get-availability?type=' + type.slug + '&weeks=8',
            { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY } }
          );
          var data = await res.json();
          availabilityCache[type.slug] = data.slots || data || [];
        } catch (err) {
          availabilityCache[type.slug] = [];
        }
      });
      
      await Promise.all(promises);
      state.slots = availabilityCache[state.selectedType.slug] || [];
      renderCalendar();
    }

    function applyAvailabilityFromCache() {
      state.slots = availabilityCache[state.selectedType.slug] || [];
      
      if (state.selectedDate) {
        var dateStillAvailable = state.slots.some(function(s) { return s.date === state.selectedDate; });
        if (!dateStillAvailable) {
          state.selectedDate = null;
          state.selectedSlot = null;
        }
      }
      
      renderCalendar();
    }

    // ================================================
    // RENDERERS
    // ================================================
    function renderFormulas() {
      var container = document.getElementById('formulas');
      container.innerHTML = '';
      
      state.prestationTypes.forEach(function(t) {
        var deposit = Math.round(t.price * (t.deposit_percent / 100));
        var isSelected = state.selectedType && state.selectedType.id === t.id;
        
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'bw__formula' + (isSelected ? ' bw__formula--selected' : '');
        btn.innerHTML = 
          '<div class="bw__formula-main">' +
            '<span class="bw__formula-name">' + t.name + '</span>' +
            '<span class="bw__formula-duration">' + t.duration_hours + 'h</span>' +
          '</div>' +
          '<p class="bw__formula-desc">' + (t.description || '') + '</p>' +
          '<div class="bw__formula-price">' +
            '<span class="bw__formula-amount">' + t.price + ' €</span>' +
            '<span class="bw__formula-deposit">Réservation ' + deposit + ' €</span>' +
          '</div>';
        
        btn.addEventListener('click', function() { selectType(t.id); });
        container.appendChild(btn);
      });
    }

    function renderCalendar() {
      var year = state.currentMonth.getFullYear();
      var month = state.currentMonth.getMonth();
      var monthNames = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
      
      document.getElementById('calendar-month').textContent = monthNames[month] + ' ' + year;
      
      var availableDates = {};
      state.slots.forEach(function(s) { availableDates[s.date] = true; });
      
      var container = document.getElementById('calendar-days');
      container.innerHTML = '';
      
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      
      var firstDay = new Date(year, month, 1);
      var lastDay = new Date(year, month + 1, 0);
      var startDay = (firstDay.getDay() + 6) % 7;
      
      // Previous month days
      var prevLast = new Date(year, month, 0).getDate();
      for (var i = startDay - 1; i >= 0; i--) {
        container.appendChild(createDayButton(prevLast - i, 'other', null));
      }
      
      // Current month days
      for (var d = 1; d <= lastDay.getDate(); d++) {
        var date = new Date(year, month, d);
        var dateStr = formatDateISO(date);
        var isAvail = availableDates[dateStr];
        var isPast = date < today;
        var isToday = date.getTime() === today.getTime();
        var isSelected = state.selectedDate === dateStr;
        
        var cls = '';
        if (isSelected) cls = 'selected';
        else if (isAvail && !isPast) cls = 'available';
        else if (isPast || !isAvail) cls = 'disabled';
        if (isToday) cls += ' today';
        
        var clickHandler = (isAvail && !isPast) ? (function(ds) { return function() { selectDate(ds); }; })(dateStr) : null;
        container.appendChild(createDayButton(d, cls, clickHandler));
      }
      
      // Next month days
      var total = container.children.length;
      var remaining = Math.ceil(total / 7) * 7 - total;
      for (var d = 1; d <= remaining; d++) {
        container.appendChild(createDayButton(d, 'other', null));
      }
      
      // Update nav buttons
      document.getElementById('btn-prev').disabled = state.currentMonth <= new Date(today.getFullYear(), today.getMonth(), 1);
      
      renderSlots();
    }
    
    function createDayButton(day, cls, onClick) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'bw__calendar__day ' + cls;
      btn.textContent = day;
      btn.disabled = cls.indexOf('disabled') >= 0 || cls.indexOf('other') >= 0;
      if (onClick) {
        btn.addEventListener('click', onClick);
      }
      return btn;
    }

    function renderSlots() {
      var container = document.getElementById('slots-panel');
      
      if (!state.selectedDate) {
        container.innerHTML = '<p class="bw__slots-empty">Sélectionnez une date</p>';
        return;
      }
      
      var dateSlots = state.slots.filter(function(s) { return s.date === state.selectedDate; });
      
      if (!dateSlots.length) {
        container.innerHTML = '<p class="bw__slots-empty">Aucun créneau disponible</p>';
        return;
      }
      
      var parts = state.selectedDate.split('-');
      var y = parseInt(parts[0]), m = parseInt(parts[1]), d = parseInt(parts[2]);
      var dateLabel = new Date(y, m - 1, d).toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
      });
      
      // Build container
      container.innerHTML = '<p class="bw__slots-date">' + dateLabel + '</p><div class="bw__slots-list" id="slots-list"></div>';
      
      var listEl = document.getElementById('slots-list');
      
      // Add slot buttons
      dateSlots.forEach(function(slot) {
        var isSelected = state.selectedSlot && state.selectedSlot.startTime === slot.startTime && state.selectedSlot.date === slot.date;
        var label = getSlotLabel(slot);
        
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'bw__slot' + (isSelected ? ' bw__slot--selected' : '');
        btn.innerHTML = '<span class="bw__slot-label">' + label + '</span>';
        btn.addEventListener('click', function() { selectSlot(slot); });
        listEl.appendChild(btn);
      });
      
      // Add continue button if slot selected
      if (state.selectedSlot) {
        var continueBtn = document.createElement('button');
        continueBtn.type = 'button';
        continueBtn.className = 'bw__slot bw__slot--continue';
        continueBtn.innerHTML = '<span class="bw__slot-label">Continuer</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>';
        continueBtn.addEventListener('click', function() {
          goToInfo();
        });
        listEl.appendChild(continueBtn);
      }
    }

    // ================================================
    // HELPERS
    // ================================================
    function formatHour(time) {
      var parts = time.split(':');
      var h = parseInt(parts[0], 10);
      var minutes = parts[1];
      return minutes === '00' ? h + 'h' : h + 'h' + minutes;
    }
    
    function getSlotLabel(slot) {
      if (slot.label) return slot.label;
      return formatHour(slot.startTime) + ' - ' + formatHour(slot.endTime);
    }

    function formatDateISO(date) {
      var y = date.getFullYear();
      var m = String(date.getMonth() + 1).padStart(2, '0');
      var d = String(date.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + d;
    }

    function formatDateLong(dateStr) {
      var parts = dateStr.split('-');
      var y = parseInt(parts[0]), m = parseInt(parts[1]), d = parseInt(parts[2]);
      return new Date(y, m - 1, d).toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
      });
    }

    // ================================================
    // HANDLERS
    // ================================================
    function selectType(id) {
      state.selectedType = state.prestationTypes.find(function(t) { return t.id === id; });
      state.selectedSlot = null;
      renderFormulas();
      applyAvailabilityFromCache();
    }

    function selectDate(dateStr) {
      state.selectedDate = dateStr;
      state.selectedSlot = null;
      renderCalendar();
    }

    function selectSlot(slot) {
      state.selectedSlot = slot;
      renderSlots();
    }

    function prevMonth() {
      state.currentMonth.setMonth(state.currentMonth.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      state.currentMonth.setMonth(state.currentMonth.getMonth() + 1);
      renderCalendar();
    }

    // ================================================
    // SUMMARY & SUBMIT
    // ================================================
    function updateSummary() {
      var t = state.selectedType;
      var s = state.selectedSlot;
      var deposit = Math.round(t.price * (t.deposit_percent / 100));
      
      var address = document.getElementById('address').value.trim();
      var postalCode = document.getElementById('postalCode').value.trim();
      var city = document.getElementById('city').value.trim();
      
      document.getElementById('summary-type').textContent = t.name;
      document.getElementById('summary-date').textContent = formatDateLong(s.date);
      document.getElementById('summary-slot').textContent = getSlotLabel(s);
      document.getElementById('summary-location').textContent = address + ', ' + postalCode + ' ' + city;
      document.getElementById('summary-total').textContent = t.price + ' €';
      document.getElementById('summary-deposit').textContent = deposit + ' €';
      document.getElementById('submit-text').textContent = 'Réserver · ' + deposit + ' €';
    }

    async function submitBooking() {
      var btn = document.getElementById('btn-submit');
      var textEl = document.getElementById('submit-text');
      
      btn.disabled = true;
      textEl.textContent = 'Chargement...';
      
      try {
        var res = await fetch(API_BASE + '/create-booking', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'apikey': SUPABASE_ANON_KEY, 
            'Authorization': 'Bearer ' + SUPABASE_ANON_KEY 
          },
          body: JSON.stringify({
            prestationType: state.selectedType.slug,
            date: state.selectedSlot.date,
            startTime: state.selectedSlot.startTime,
            endTime: state.selectedSlot.endTime,
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            address: document.getElementById('address').value.trim(),
            postalCode: document.getElementById('postalCode').value.trim(),
            city: document.getElementById('city').value.trim(),
            notes: document.getElementById('notes').value.trim()
          })
        });
        
        var data = await res.json();
        if (data.error) throw new Error(data.error);
        if (data.checkoutUrl) window.location.href = data.checkoutUrl;
      } catch (err) {
        showError(err.message || "Une erreur est survenue");
        btn.disabled = false;
        var deposit = Math.round(state.selectedType.price * (state.selectedType.deposit_percent / 100));
        textEl.textContent = 'Réserver · ' + deposit + ' €';
      }
    }

    // ================================================
    // UTILITY
    // ================================================
    function showLoading(show) {
      var loadingEl = document.getElementById('loading');
      var calendarView = document.getElementById('view-calendar');
      
      if (show) {
        loadingEl.classList.add('visible');
        calendarView.classList.remove('active');
      } else {
        loadingEl.classList.remove('visible');
        calendarView.classList.add('active');
      }
    }

    function showError(msg) {
      var el = document.getElementById('error');
      el.textContent = msg;
      el.classList.add('visible');
      setTimeout(function() { el.classList.remove('visible'); }, 5000);
    }
  </script>
</body>
</html>
