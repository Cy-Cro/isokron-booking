<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Réservation - ISOKRON Studio</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.47;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
    }
    
    .bw {
      width: 100%;
      max-width: 680px;
    }
    
    /* Header */
    .bw__header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .bw__back {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      margin-left: -0.75rem;
      margin-bottom: 0.5rem;
      background: none;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      color: #0071e3;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .bw__back:hover {
      background: rgba(0, 113, 227, 0.08);
      color: #0077ed;
    }
    
    .bw__back svg {
      width: 18px;
      height: 18px;
    }
    
    .bw__title {
      font-size: 28px;
      font-weight: 600;
      color: #1d1d1f;
      margin: 0;
    }
    
    /* Error */
    .bw__error {
      background: #fff0f0;
      color: #de071c;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 1.5rem;
      display: none;
    }
    
    .bw__error.visible {
      display: block;
    }
    
    /* Content */
    .bw__content {
      display: flex;
      flex-direction: column;
      gap: 2.5rem;
    }
    
    /* Section */
    .bw__section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #86868b;
      margin-bottom: 1rem;
    }
    
    /* Formulas */
    .bw__formulas {
      display: flex;
      gap: 0.75rem;
    }
    
    @media (max-width: 600px) {
      .bw__formulas {
        flex-direction: column;
      }
    }
    
    .bw__formula {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem 1.25rem;
      background: #fff;
      border: 1.5px solid #d2d2d7;
      border-radius: 12px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s ease;
    }
    
    .bw__formula:hover:not(.bw__formula--selected) {
      border-color: #86868b;
    }
    
    .bw__formula--selected,
    .bw__formula--selected:hover {
      border-color: #0071e3;
      background: #f5f8ff;
    }
    
    .bw__formula-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    
    .bw__formula-name {
      font-size: 15px;
      font-weight: 600;
      color: #1d1d1f;
    }
    
    .bw__formula-duration {
      font-size: 13px;
      color: #86868b;
    }
    
    .bw__formula-desc {
      font-size: 13px;
      color: #86868b;
      line-height: 1.4;
      margin-bottom: 0.75rem;
    }
    
    .bw__formula-price {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-top: auto;
      padding-top: 0.75rem;
      border-top: 1px solid #f5f5f7;
    }
    
    .bw__formula-amount {
      font-size: 15px;
      font-weight: 600;
      color: #1d1d1f;
    }
    
    .bw__formula-deposit {
      font-size: 12px;
      color: #86868b;
    }
    
    /* Scheduling */
    .bw__scheduling {
      display: grid;
      grid-template-columns: 1fr 240px;
      gap: 1.5rem;
      background: #fff;
      border-radius: 14px;
      padding: 1.25rem;
      border: 1px solid #d2d2d7;
      align-items: start;
    }
    
    @media (max-width: 600px) {
      .bw__scheduling {
        grid-template-columns: 1fr;
      }
      
      .bw__slots {
        margin-top: 0.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e5e5;
      }
    }
    
    /* Calendar */
    .bw__calendar {
      position: relative;
    }
    
    .bw__calendar__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .bw__calendar__title {
      font-size: 15px;
      font-weight: 600;
      color: #1d1d1f;
    }
    
    .bw__calendar__nav {
      display: flex;
      gap: 0.25rem;
    }
    
    .bw__calendar__nav button {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: 1px solid #d2d2d7;
      border-radius: 6px;
      color: #86868b;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .bw__calendar__nav button:hover:not(:disabled) {
      background: #f5f5f7;
      border-color: #86868b;
    }
    
    .bw__calendar__nav button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .bw__calendar__nav button svg {
      width: 16px;
      height: 16px;
    }
    
    .bw__calendar__weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: 0.5rem;
    }
    
    .bw__calendar__weekdays span {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #86868b;
      padding: 0.5rem 0;
    }
    
    .bw__calendar__days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    
    .bw__calendar__day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      border-radius: 10px;
      border: none;
      background: none;
      color: #1d1d1f;
      cursor: pointer;
      transition: all 0.1s ease;
    }
    
    .bw__calendar__day:hover:not(:disabled):not(.selected) {
      background: #f5f5f7;
    }
    
    .bw__calendar__day.today {
      font-weight: 600;
    }
    
    .bw__calendar__day.available {
      background: #e8f4fd;
      color: #0071e3;
      font-weight: 500;
    }
    
    .bw__calendar__day.available:hover:not(.selected) {
      background: #d4ebfc;
    }
    
    .bw__calendar__day.selected,
    .bw__calendar__day.selected:hover {
      background: #0071e3;
      color: #fff;
      font-weight: 600;
    }
    
    .bw__calendar__day.disabled {
      color: #d2d2d7;
      cursor: not-allowed;
    }
    
    .bw__calendar__day.other {
      color: #d2d2d7;
    }
    
    /* Slots */
    .bw__slots {
      display: flex;
      flex-direction: column;
      min-width: 200px;
    }
    
    .bw__slots-empty {
      font-size: 13px;
      color: #86868b;
      text-align: center;
      padding: 2rem 1rem;
    }
    
    .bw__slots-date {
      font-size: 13px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 0.75rem;
      text-transform: capitalize;
    }
    
    .bw__slots-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .bw__slot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #f5f5f7;
      border: 1.5px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 48px;
      text-align: left;
    }
    
    .bw__slot:hover:not(.bw__slot--selected):not(.bw__slot--continue) {
      border-color: #0071e3;
      background: #f0f7ff;
    }
    
    .bw__slot--selected,
    .bw__slot--selected:hover {
      background: #0071e3;
      border-color: #0071e3;
    }
    
    .bw__slot-label {
      font-size: 14px;
      font-weight: 500;
      color: #1d1d1f;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .bw__slot--selected .bw__slot-label {
      color: #fff;
    }
    
    .bw__slot-time {
      font-size: 13px;
      color: #86868b;
      white-space: nowrap;
      margin-left: 0.75rem;
      flex-shrink: 0;
    }
    
    .bw__slot--selected .bw__slot-time {
      color: rgba(255,255,255,0.85);
    }
    
    /* Bouton Continuer dans la liste des créneaux */
    .bw__slot--continue {
      background: #0071e3;
      border-color: #0071e3;
      margin-top: 0.25rem;
    }
    
    .bw__slot--continue:hover {
      background: #0077ed;
      border-color: #0077ed;
    }
    
    .bw__slot--continue .bw__slot-label {
      color: #fff;
      font-weight: 600;
    }
    
    .bw__slot--continue svg {
      color: #fff;
      flex-shrink: 0;
      width: 18px;
      height: 18px;
    }
    
    /* Form */
    .bw__form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: #fff;
      border: 1px solid #d2d2d7;
      border-radius: 14px;
      padding: 1.25rem;
    }
    
    .bw__field {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }
    
    .bw__field label {
      font-size: 13px;
      font-weight: 500;
      color: #1d1d1f;
    }
    
    .bw__field label span {
      font-weight: 400;
      color: #86868b;
    }
    
    .bw__field input,
    .bw__field textarea {
      padding: 0.625rem 0.875rem;
      border: 1px solid #d2d2d7;
      border-radius: 10px;
      font-size: 15px;
      color: #1d1d1f;
      background: #fff;
      transition: all 0.15s ease;
      font-family: inherit;
    }
    
    .bw__field input:focus,
    .bw__field textarea:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.1);
    }
    
    .bw__field input::placeholder,
    .bw__field textarea::placeholder {
      color: #86868b;
    }
    
    .bw__field textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .bw__field-row {
      display: flex;
      gap: 0.75rem;
    }
    
    .bw__field-row .bw__field {
      flex: 1;
    }
    
    /* Summary */
    .bw__summary {
      background: #fff;
      border: 1px solid #d2d2d7;
      border-radius: 14px;
      padding: 1.25rem;
    }
    
    .bw__summary-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 0.625rem 0;
      font-size: 14px;
    }
    
    .bw__summary-row > span:first-child {
      color: #86868b;
    }
    
    .bw__summary-row > span:last-child {
      color: #1d1d1f;
      font-weight: 500;
      text-align: right;
      max-width: 60%;
    }
    
    .bw__summary-divider {
      height: 1px;
      background: #d2d2d7;
      margin: 0.5rem 0;
    }
    
    .bw__summary-row--highlight > span:last-child {
      font-size: 17px;
      font-weight: 600;
      color: #0071e3;
    }
    
    /* Legal */
    .bw__legal {
      font-size: 12px;
      color: #86868b;
      text-align: center;
      margin: 1.5rem 0 1rem;
      line-height: 1.5;
    }
    
    .bw__legal a {
      color: #0071e3;
      text-decoration: none;
    }
    
    .bw__legal a:hover {
      text-decoration: underline;
    }
    
    /* CTA */
    .bw__cta {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.875rem 1.5rem;
      margin-top: 1.5rem;
      background: #1d1d1f;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .bw__cta:hover:not(:disabled) {
      background: #000;
    }
    
    .bw__cta:disabled {
      background: #86868b;
      cursor: not-allowed;
    }
    
    .bw__cta--primary {
      background: #0071e3;
    }
    
    .bw__cta--primary:hover:not(:disabled) {
      background: #0077ed;
    }
    
    .bw__cta svg {
      width: 18px;
      height: 18px;
    }
    
    /* Loading */
    .bw__loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
    }
    
    .bw__spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #d2d2d7;
      border-top-color: #0071e3;
      border-radius: 50%;
      animation: bw-spin 0.6s linear infinite;
    }
    
    @keyframes bw-spin {
      to { transform: rotate(360deg); }
    }
    
    /* Views */
    .view { display: none; }
    .view.active { display: block; }
  </style>
</head>
<body>
  <div class="bw">
    <!-- Error -->
    <div id="error" class="bw__error"></div>
    
    <!-- Loading -->
    <div id="loading" class="bw__loading" style="display: none;">
      <div class="bw__spinner"></div>
    </div>
    
    <!-- STEP 1: Calendar -->
    <div id="view-calendar" class="view active">
      <header class="bw__header">
        <h1 class="bw__title">Réserver une séance</h1>
      </header>
      
      <div class="bw__content">
        <!-- Formulas -->
        <section>
          <h2 class="bw__section-title">Choisissez votre formule</h2>
          <div class="bw__formulas" id="formulas"></div>
        </section>
        
        <!-- Calendar + Slots -->
        <section>
          <h2 class="bw__section-title">Sélectionnez une date</h2>
          <div class="bw__scheduling">
            <div class="bw__calendar">
              <div class="bw__calendar__header">
                <span class="bw__calendar__title" id="calendar-month"></span>
                <div class="bw__calendar__nav">
                  <button onclick="prevMonth()" id="btn-prev">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                  </button>
                  <button onclick="nextMonth()" id="btn-next">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                  </button>
                </div>
              </div>
              <div class="bw__calendar__weekdays">
                <span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span><span>D</span>
              </div>
              <div class="bw__calendar__days" id="calendar-days"></div>
            </div>
            
            <!-- Slots Panel -->
            <div class="bw__slots" id="slots-panel">
              <p class="bw__slots-empty">Sélectionnez une date</p>
            </div>
          </div>
        </section>
      </div>
    </div>
    
    <!-- STEP 2: Form -->
    <div id="view-form" class="view">
      <button class="bw__back" onclick="showView('calendar')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        <span>Retour</span>
      </button>
      
      <header class="bw__header">
        <h1 class="bw__title">Vos coordonnées</h1>
      </header>
      
      <div class="bw__content">
        <form id="booking-form" onsubmit="submitForm(event)" autocomplete="off">
          <div class="bw__form">
            <div class="bw__field-row">
              <div class="bw__field">
                <label>Prénom *</label>
                <input type="text" id="firstName" placeholder="Jean" required autocomplete="off">
              </div>
              <div class="bw__field">
                <label>Nom *</label>
                <input type="text" id="lastName" placeholder="Dupont" required autocomplete="off">
              </div>
            </div>
            
            <div class="bw__field">
              <label>Email *</label>
              <input type="email" id="email" placeholder="jean@exemple.com" required autocomplete="off">
            </div>
            
            <div class="bw__field">
              <label>Téléphone</label>
              <input type="tel" id="phone" placeholder="06 12 34 56 78" autocomplete="off">
            </div>
            
            <div class="bw__field">
              <label>Adresse du shooting *</label>
              <input type="text" id="address" placeholder="12 rue du Commerce" required autocomplete="off">
            </div>
            
            <div class="bw__field-row">
              <div class="bw__field">
                <label>Code postal *</label>
                <input type="text" id="postalCode" placeholder="75001" required autocomplete="off">
              </div>
              <div class="bw__field">
                <label>Ville *</label>
                <input type="text" id="city" placeholder="Paris" required autocomplete="off">
              </div>
            </div>
            
            <div class="bw__field">
              <label>Notes <span>(optionnel)</span></label>
              <textarea id="notes" placeholder="Accès, parking, code d'entrée..." autocomplete="off"></textarea>
            </div>
          </div>
          
          <div class="bw__summary" style="margin-top: 1.5rem;">
            <div class="bw__summary-row">
              <span>Prestation</span>
              <span id="summary-type"></span>
            </div>
            <div class="bw__summary-row">
              <span>Date</span>
              <span id="summary-date"></span>
            </div>
            <div class="bw__summary-row">
              <span>Créneau</span>
              <span id="summary-slot"></span>
            </div>
            <div class="bw__summary-divider"></div>
            <div class="bw__summary-row">
              <span>Prix total</span>
              <span id="summary-total"></span>
            </div>
            <div class="bw__summary-row bw__summary-row--highlight">
              <span>Acompte à payer</span>
              <span id="summary-deposit"></span>
            </div>
          </div>
          
          <p class="bw__legal">
            En continuant, vous acceptez nos <a href="https://isokron.fr/cgv" target="_blank">CGV</a> 
            et notre <a href="https://isokron.fr/confidentialite" target="_blank">politique de confidentialité</a>.
          </p>
          
          <button type="submit" class="bw__cta bw__cta--primary" id="submit-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            <span id="submit-text">Payer l'acompte</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ================================================
    // CONFIG - À MODIFIER AVEC VOS VALEURS
    // ================================================
    const SUPABASE_URL = "https://eenyygeizwabcfnotcdl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlbnl5Z2VpendhYmNmbm90Y2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzE4MDIsImV4cCI6MjA4MDgwNzgwMn0.aSif5DIk1Bv8wdJWDofHNmuscNbi5-B2NlGEmFhVFoY";
    const API_BASE = `${SUPABASE_URL}/functions/v1`;

    // ================================================
    // STATE
    // ================================================
    let state = {
      prestationTypes: [],
      selectedType: null,
      slots: [],
      selectedDate: null,
      selectedSlot: null,
      currentMonth: new Date()
    };
    
    // Cache des disponibilités par type
    const availabilityCache = {};

    // ================================================
    // INIT
    // ================================================
    document.addEventListener('DOMContentLoaded', loadPrestationTypes);

    // ================================================
    // DATA LOADING
    // ================================================
    async function loadPrestationTypes() {
      showLoading(true);
      try {
        const res = await fetch(
          `${SUPABASE_URL}/rest/v1/prestation_types?is_active=eq.true&order=price.asc`,
          { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
        );
        const types = await res.json();
        if (types?.length) {
          state.prestationTypes = types;
          state.selectedType = types[0];
          renderFormulas();
          
          // Charger toutes les disponibilités en parallèle
          await loadAllAvailabilities();
        }
      } catch (err) {
        showError("Impossible de charger les formules.");
      } finally {
        showLoading(false);
      }
    }

    async function loadAllAvailabilities() {
      const promises = state.prestationTypes.map(async (type) => {
        try {
          const res = await fetch(
            `${API_BASE}/get-availability?type=${type.slug}&weeks=8`,
            { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
          );
          const data = await res.json();
          // Support nouveau format (object avec slots) et ancien format (array)
          availabilityCache[type.slug] = data.slots || data || [];
        } catch (err) {
          console.error(`Erreur chargement disponibilités ${type.slug}:`, err);
          availabilityCache[type.slug] = [];
        }
      });
      
      await Promise.all(promises);
      
      // Appliquer les slots du type sélectionné
      state.slots = availabilityCache[state.selectedType.slug] || [];
      renderCalendar();
    }

    function applyAvailabilityFromCache() {
      state.slots = availabilityCache[state.selectedType.slug] || [];
      renderCalendar();
    }

    // ================================================
    // RENDERERS
    // ================================================
    function renderFormulas() {
      const el = document.getElementById('formulas');
      el.innerHTML = state.prestationTypes.map(t => {
        const deposit = Math.round(t.price * (t.deposit_percent / 100));
        const sel = state.selectedType?.id === t.id;
        return `
          <button class="bw__formula ${sel ? 'bw__formula--selected' : ''}" onclick="selectType('${t.id}')">
            <div class="bw__formula-main">
              <span class="bw__formula-name">${t.name}</span>
              <span class="bw__formula-duration">${t.duration_hours}h</span>
            </div>
            <p class="bw__formula-desc">${t.description || ''}</p>
            <div class="bw__formula-price">
              <span class="bw__formula-amount">${t.price} €</span>
              <span class="bw__formula-deposit">Acompte ${deposit} €</span>
            </div>
          </button>
        `;
      }).join('');
    }

    function renderCalendar() {
      const year = state.currentMonth.getFullYear();
      const month = state.currentMonth.getMonth();
      const monthNames = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
      document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
      
      const availableDates = new Set(state.slots.map(s => s.date));
      const container = document.getElementById('calendar-days');
      container.innerHTML = '';
      
      const today = new Date(); today.setHours(0,0,0,0);
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = (firstDay.getDay() + 6) % 7;
      
      // Jours du mois précédent
      const prevLast = new Date(year, month, 0).getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        container.appendChild(createDay(prevLast - i, 'other'));
      }
      
      // Jours du mois courant
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(year, month, d);
        const dateStr = formatDateISO(date);
        const isAvail = availableDates.has(dateStr);
        const isPast = date < today;
        const isToday = date.getTime() === today.getTime();
        const isSel = state.selectedDate === dateStr;
        
        let cls = '';
        if (isSel) cls = 'selected';
        else if (isAvail && !isPast) cls = 'available';
        else if (isPast) cls = 'disabled';
        if (isToday) cls += ' today';
        
        const btn = createDay(d, cls);
        if (isAvail && !isPast) btn.onclick = () => selectDate(dateStr);
        container.appendChild(btn);
      }
      
      // Jours du mois suivant
      const total = container.children.length;
      const remaining = Math.ceil(total / 7) * 7 - total;
      for (let d = 1; d <= remaining; d++) {
        container.appendChild(createDay(d, 'other'));
      }
      
      document.getElementById('btn-prev').disabled = state.currentMonth <= new Date(today.getFullYear(), today.getMonth(), 1);
      renderSlots();
    }

    function createDay(day, cls) {
      const btn = document.createElement('button');
      btn.className = `bw__calendar__day ${cls}`;
      btn.textContent = day;
      btn.type = 'button';
      if (cls.includes('disabled') || cls.includes('other')) btn.disabled = true;
      return btn;
    }

    function renderSlots() {
      const el = document.getElementById('slots-panel');
      
      if (!state.selectedDate) {
        el.innerHTML = '<p class="bw__slots-empty">Sélectionnez une date</p>';
        return;
      }
      
      const dateSlots = state.slots.filter(s => s.date === state.selectedDate);
      if (!dateSlots.length) {
        el.innerHTML = '<p class="bw__slots-empty">Aucun créneau disponible</p>';
        return;
      }
      
      const [y, m, d] = state.selectedDate.split('-').map(Number);
      const dateLabel = new Date(y, m-1, d).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
      
      // Générer les créneaux - afficher seulement le label (qui contient déjà les heures)
      let slotsHtml = dateSlots.map(slot => {
        const sel = state.selectedSlot?.startTime === slot.startTime && state.selectedSlot?.date === slot.date;
        const label = getSlotLabel(slot);
        return `
          <button type="button" class="bw__slot ${sel ? 'bw__slot--selected' : ''}" onclick='selectSlot(${JSON.stringify(slot)})'>
            <span class="bw__slot-label">${label}</span>
          </button>
        `;
      }).join('');
      
      // Ajouter le bouton Continuer s'il y a un créneau sélectionné
      if (state.selectedSlot) {
        slotsHtml += `
          <button type="button" class="bw__slot bw__slot--continue" onclick="showView('form')">
            <span class="bw__slot-label">Continuer</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
          </button>
        `;
      }
      
      el.innerHTML = `
        <p class="bw__slots-date">${dateLabel}</p>
        <div class="bw__slots-list">
          ${slotsHtml}
        </div>
      `;
    }

    // ================================================
    // SLOT LABEL & TIME HELPERS (Dynamiques)
    // ================================================
    
    /**
     * Formate une heure "09:00" en "9h" ou "09:30" en "9h30"
     */
    function formatHour(time) {
      const [hours, minutes] = time.split(':');
      const h = parseInt(hours, 10);
      if (minutes === '00') {
        return `${h}h`;
      }
      return `${h}h${minutes}`;
    }
    
    /**
     * Retourne le label du créneau
     * Utilise le label de l'API s'il existe, sinon génère un label avec les heures
     */
    function getSlotLabel(slot) {
      // Si l'API fournit un label, l'utiliser
      if (slot.label) {
        return slot.label;
      }
      
      // Sinon générer un label avec les heures seulement
      return `${formatHour(slot.startTime)} - ${formatHour(slot.endTime)}`;
    }
    
    /**
     * Retourne l'affichage des heures : "9h – 12h"
     */
    function getSlotTime(slot) {
      return `${formatHour(slot.startTime)} – ${formatHour(slot.endTime)}`;
    }

    // ================================================
    // HANDLERS
    // ================================================
    function selectType(id) {
      state.selectedType = state.prestationTypes.find(t => t.id === id);
      // Garder la date sélectionnée, réinitialiser seulement le créneau
      state.selectedSlot = null;
      renderFormulas();
      applyAvailabilityFromCache();
      
      // Vérifier si la date est toujours disponible
      if (state.selectedDate) {
        const dateStillAvailable = state.slots.some(s => s.date === state.selectedDate);
        if (!dateStillAvailable) {
          state.selectedDate = null;
        }
      }
      renderCalendar();
    }

    function selectDate(dateStr) {
      state.selectedDate = dateStr;
      state.selectedSlot = null;
      renderCalendar();
    }

    function selectSlot(slot) {
      state.selectedSlot = slot;
      renderSlots();
    }

    function prevMonth() {
      state.currentMonth.setMonth(state.currentMonth.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      state.currentMonth.setMonth(state.currentMonth.getMonth() + 1);
      renderCalendar();
    }

    function showView(name) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(`view-${name}`).classList.add('active');
      if (name === 'form') updateSummary();
    }

    function updateSummary() {
      const t = state.selectedType;
      const s = state.selectedSlot;
      const deposit = Math.round(t.price * (t.deposit_percent / 100));
      const [y, m, d] = s.date.split('-').map(Number);
      
      document.getElementById('summary-type').textContent = t.name;
      document.getElementById('summary-date').textContent = new Date(y, m-1, d).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
      document.getElementById('summary-slot').textContent = `${getSlotLabel(s)} · ${getSlotTime(s)}`;
      document.getElementById('summary-total').textContent = `${t.price} €`;
      document.getElementById('summary-deposit').textContent = `${deposit} €`;
      document.getElementById('submit-text').textContent = `Payer ${deposit} €`;
    }

    async function submitForm(e) {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      document.getElementById('submit-text').textContent = 'Chargement...';
      
      try {
        const res = await fetch(`${API_BASE}/create-booking`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
          body: JSON.stringify({
            prestationType: state.selectedType.slug,
            date: state.selectedSlot.date,
            startTime: state.selectedSlot.startTime,
            endTime: state.selectedSlot.endTime,
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            address: document.getElementById('address').value.trim(),
            postalCode: document.getElementById('postalCode').value.trim(),
            city: document.getElementById('city').value.trim(),
            notes: document.getElementById('notes').value.trim()
          })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        if (data.checkoutUrl) window.location.href = data.checkoutUrl;
      } catch (err) {
        showError(err.message || "Erreur");
        btn.disabled = false;
        const deposit = Math.round(state.selectedType.price * (state.selectedType.deposit_percent / 100));
        document.getElementById('submit-text').textContent = `Payer ${deposit} €`;
      }
    }

    // ================================================
    // UTILITY FUNCTIONS
    // ================================================
    function formatDateISO(date) {
      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
      document.getElementById('view-calendar').style.display = show ? 'none' : 'block';
    }

    function showError(msg) {
      const el = document.getElementById('error');
      el.textContent = msg;
      el.classList.add('visible');
      setTimeout(() => el.classList.remove('visible'), 5000);
    }
  </script>
</body>
</html>
