<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Réservation - ISOKRON Studio</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: #f5f5f5;
      color: #111;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    /* Header */
    .header {
      padding: 28px 32px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(to bottom, #fafafa, #fff);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
    }

    .brand-name {
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .event-title {
      font-size: 22px;
      font-weight: 600;
      margin-top: 2px;
    }

    .event-description {
      color: #6b7280;
      font-size: 14px;
      margin-top: 12px;
      max-width: 500px;
    }

    .event-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 16px;
      font-size: 14px;
      color: #374151;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .meta-item svg {
      width: 16px;
      height: 16px;
      color: #6b7280;
    }

    .price-badge {
      background: #111;
      color: #fff;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 500;
    }

    /* Main content */
    .main {
      display: flex;
      min-height: 450px;
    }

    @media (max-width: 768px) {
      .main {
        flex-direction: column;
      }
      .header {
        padding: 20px;
      }
      .type-panel, .calendar-panel, .slots-panel {
        padding: 20px !important;
      }
    }

    /* Type selection panel */
    .type-panel {
      width: 100%;
      padding: 24px 32px;
      border-bottom: 1px solid #e5e7eb;
      background: #fafafa;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .type-options {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .type-option {
      flex: 1;
      min-width: 200px;
      padding: 16px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      background: #fff;
    }

    .type-option:hover {
      border-color: #9ca3af;
      transform: translateY(-1px);
    }

    .type-option.selected {
      border-color: #111;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .type-option-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .type-option-title {
      font-weight: 600;
      font-size: 15px;
    }

    .type-option-duration {
      font-size: 12px;
      color: #6b7280;
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .type-option-description {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .type-option-price {
      font-size: 15px;
      font-weight: 600;
    }

    .type-option-deposit {
      font-size: 12px;
      color: #6b7280;
      font-weight: 400;
    }

    /* Calendar panel */
    .calendar-panel {
      flex: 1;
      padding: 24px 32px;
      border-right: 1px solid #e5e7eb;
    }

    @media (max-width: 768px) {
      .calendar-panel {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
      }
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-title {
      font-size: 16px;
      font-weight: 600;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
    }

    .calendar-nav button {
      width: 32px;
      height: 32px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .calendar-nav button:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .calendar-nav button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .weekday {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #9ca3af;
      padding: 8px 0;
      text-transform: uppercase;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      background: transparent;
      position: relative;
    }

    .calendar-day:hover:not(.disabled):not(.selected) {
      background: #f3f4f6;
    }

    .calendar-day.today {
      font-weight: 600;
    }

    .calendar-day.available {
      background: #f0fdf4;
      color: #166534;
      font-weight: 500;
    }

    .calendar-day.available:hover {
      background: #dcfce7;
    }

    .calendar-day.selected {
      background: #111;
      color: #fff;
    }

    .calendar-day.disabled {
      color: #d1d5db;
      cursor: not-allowed;
    }

    .calendar-day.other-month {
      color: #d1d5db;
    }

    /* Slots panel */
    .slots-panel {
      width: 240px;
      padding: 24px;
      background: #fafafa;
    }

    @media (max-width: 768px) {
      .slots-panel {
        width: 100%;
      }
    }

    .slots-date {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 16px;
    }

    .slots-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .slot-button {
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
      text-align: center;
    }

    .slot-button:hover {
      border-color: #111;
    }

    .slot-button.selected {
      background: #111;
      color: #fff;
      border-color: #111;
    }

    .no-slots {
      text-align: center;
      color: #9ca3af;
      padding: 40px 16px;
      font-size: 14px;
    }

    .continue-btn {
      width: 100%;
      margin-top: 16px;
      padding: 14px;
      background: #111;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .continue-btn:hover {
      background: #333;
    }

    /* Form view */
    .form-view {
      display: none;
      flex-direction: column;
    }

    .form-view.active {
      display: flex;
    }

    .calendar-view {
      display: flex;
      flex-direction: column;
    }

    .calendar-view.hidden {
      display: none;
    }

    .back-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 32px;
      background: #fafafa;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #6b7280;
      border-bottom: 1px solid #e5e7eb;
      transition: color 0.2s;
    }

    .back-button:hover {
      color: #111;
    }

    .form-container {
      padding: 32px;
      max-width: 500px;
      margin: 0 auto;
      width: 100%;
    }

    .form-header {
      margin-bottom: 28px;
      text-align: center;
    }

    .form-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-subtitle {
      font-size: 14px;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }

    .form-label .required {
      color: #ef4444;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s;
      background: #fff;
    }

    .form-input:focus {
      outline: none;
      border-color: #111;
      box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
    }

    .form-input::placeholder {
      color: #9ca3af;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .form-footer {
      margin-top: 28px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }

    .form-summary {
      background: #f9fafb;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .form-summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .form-summary-row:last-child {
      margin-bottom: 0;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
      font-weight: 600;
    }

    .form-summary-label {
      color: #6b7280;
    }

    .form-legal {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 16px;
      text-align: center;
    }

    .form-legal a {
      color: #111;
    }

    .btn-primary {
      width: 100%;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: #111;
      color: #fff;
    }

    .btn-primary:hover {
      background: #333;
    }

    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* Loading state */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e5e7eb;
      border-top-color: #111;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error */
    .error-message {
      background: #fef2f2;
      color: #b91c1c;
      padding: 12px 16px;
      border-radius: 10px;
      margin: 16px 32px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .error-message.hidden {
      display: none;
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-option {
      height: 100px;
      flex: 1;
      min-width: 200px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Error message -->
    <div id="error" class="error-message hidden">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <span id="error-text"></span>
    </div>

    <!-- Calendar View -->
    <div id="calendar-view" class="calendar-view">
      <div class="header">
        <div class="header-content">
          <div class="avatar">IS</div>
          <div>
            <div class="brand-name">Isokron Studio</div>
            <div class="event-title" id="event-title">Séance Photo</div>
          </div>
        </div>
        <p class="event-description" id="event-description">Séance photo professionnelle avec livraison des photos retouchées.</p>
        <div class="event-meta">
          <div class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="event-duration">3h</span>
          </div>
          <div class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span>À votre adresse</span>
          </div>
          <div class="meta-item">
            <span class="price-badge" id="event-price">Acompte 105 €</span>
          </div>
        </div>
      </div>

      <!-- Type selection -->
      <div class="type-panel">
        <div class="section-title">Choisissez votre formule</div>
        <div class="type-options" id="type-options">
          <!-- Loaded dynamically -->
          <div class="skeleton skeleton-option"></div>
          <div class="skeleton skeleton-option"></div>
        </div>
      </div>

      <div class="main">
        <!-- Calendar -->
        <div class="calendar-panel">
          <div class="calendar-header">
            <div class="calendar-title" id="calendar-month">décembre 2025</div>
            <div class="calendar-nav">
              <button onclick="prevMonth()" id="prev-month">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <button onclick="nextMonth()" id="next-month">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="calendar-weekdays">
            <div class="weekday">Lun</div>
            <div class="weekday">Mar</div>
            <div class="weekday">Mer</div>
            <div class="weekday">Jeu</div>
            <div class="weekday">Ven</div>
            <div class="weekday">Sam</div>
            <div class="weekday">Dim</div>
          </div>
          <div class="calendar-days" id="calendar-days"></div>
        </div>

        <!-- Slots -->
        <div class="slots-panel">
          <div id="slots-content">
            <div class="no-slots">Sélectionnez une date</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form View -->
    <div id="form-view" class="form-view">
      <button class="back-button" onclick="showCalendarView()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        Retour au calendrier
      </button>

      <div class="form-container">
        <div class="form-header">
          <div class="form-title">Vos coordonnées</div>
          <div class="form-subtitle">
            <span id="form-prestation"></span>
            <span>•</span>
            <span id="form-datetime"></span>
          </div>
        </div>

        <form id="booking-form" onsubmit="submitForm(event)">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Prénom <span class="required">*</span></label>
              <input type="text" class="form-input" id="firstName" placeholder="Jean" required>
            </div>
            <div class="form-group">
              <label class="form-label">Nom <span class="required">*</span></label>
              <input type="text" class="form-input" id="lastName" placeholder="Dupont" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Email <span class="required">*</span></label>
            <input type="email" class="form-input" id="email" placeholder="jean@exemple.com" required>
          </div>

          <div class="form-group">
            <label class="form-label">Téléphone</label>
            <input type="tel" class="form-input" id="phone" placeholder="06 12 34 56 78">
          </div>

          <div class="form-group">
            <label class="form-label">Adresse du shooting <span class="required">*</span></label>
            <input type="text" class="form-input" id="address" placeholder="123 rue de la Photo" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Code postal <span class="required">*</span></label>
              <input type="text" class="form-input" id="postalCode" placeholder="75001" required>
            </div>
            <div class="form-group">
              <label class="form-label">Ville <span class="required">*</span></label>
              <input type="text" class="form-input" id="city" placeholder="Paris" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notes (accès, parking...)</label>
            <textarea class="form-input form-textarea" id="notes" placeholder="Informations utiles pour le jour J"></textarea>
          </div>

          <div class="form-footer">
            <div class="form-summary">
              <div class="form-summary-row">
                <span class="form-summary-label">Prestation</span>
                <span id="summary-prestation">-</span>
              </div>
              <div class="form-summary-row">
                <span class="form-summary-label">Prix total</span>
                <span id="summary-total">-</span>
              </div>
              <div class="form-summary-row">
                <span class="form-summary-label">Acompte à payer</span>
                <span id="summary-deposit">-</span>
              </div>
            </div>

            <p class="form-legal">
              En continuant, vous acceptez nos <a href="https://isokron.fr/cgv" target="_blank">CGV</a> et notre <a href="https://isokron.fr/confidentialite" target="_blank">politique de confidentialité</a>.
            </p>

            <button type="submit" class="btn-primary" id="submit-btn">Payer l'acompte</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading" class="loading-overlay hidden">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    // Configuration Supabase
    const SUPABASE_URL = "https://eenyygeizwabcfnotcdl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlbnl5Z2VpendhYmNmbm90Y2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzE4MDIsImV4cCI6MjA4MDgwNzgwMn0.aSif5DIk1Bv8wdJWDofHNmuscNbi5-B2NlGEmFhVFoY";
    const API_BASE = `${SUPABASE_URL}/functions/v1`;

    // State
    let state = {
      prestationTypes: [],
      selectedType: null,
      slots: [],
      selectedDate: null,
      selectedSlot: null,
      currentMonth: new Date(),
      loading: false
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadPrestationTypes();
    });

    // Load prestation types from Supabase
    async function loadPrestationTypes() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/prestation_types?is_active=eq.true&order=price.asc`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );
        
        const types = await response.json();
        
        if (types && types.length > 0) {
          state.prestationTypes = types;
          state.selectedType = types[0];
          renderPrestationTypes();
          updateHeader();
          loadAvailability();
        } else {
          // Fallback si pas de données
          state.prestationTypes = [
            { id: '1', slug: 'demi-journee', name: 'Demi-journée', description: '3h de shooting, 20 photos minimum', duration_hours: 3, price: 350, deposit_percent: 30, is_active: true },
            { id: '2', slug: 'journee', name: 'Journée complète', description: '6h de shooting, 40 photos minimum', duration_hours: 6, price: 550, deposit_percent: 30, is_active: true }
          ];
          state.selectedType = state.prestationTypes[0];
          renderPrestationTypes();
          updateHeader();
          loadAvailability();
        }
      } catch (err) {
        console.error('Error loading prestation types:', err);
        showError("Impossible de charger les formules. Veuillez rafraîchir la page.");
      }
    }

    // Render prestation type options
    function renderPrestationTypes() {
      const container = document.getElementById('type-options');
      container.innerHTML = state.prestationTypes.map(type => {
        const deposit = Math.round(type.price * (type.deposit_percent / 100));
        const isSelected = state.selectedType?.id === type.id;
        return `
          <div class="type-option ${isSelected ? 'selected' : ''}" onclick="selectType('${type.id}')">
            <div class="type-option-header">
              <div class="type-option-title">${type.name}</div>
              <div class="type-option-duration">${type.duration_hours}h</div>
            </div>
            <div class="type-option-description">${type.description || ''}</div>
            <div class="type-option-price">
              ${type.price} € 
              <span class="type-option-deposit">(acompte ${deposit} €)</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Select prestation type
    function selectType(typeId) {
      state.selectedType = state.prestationTypes.find(t => t.id === typeId);
      state.selectedDate = null;
      state.selectedSlot = null;
      
      renderPrestationTypes();
      updateHeader();
      loadAvailability();
    }

    // Update header with selected type info
    function updateHeader() {
      if (!state.selectedType) return;
      
      const type = state.selectedType;
      const deposit = Math.round(type.price * (type.deposit_percent / 100));
      
      document.getElementById('event-title').textContent = `Séance Photo ${type.name}`;
      document.getElementById('event-description').textContent = type.description || 'Séance photo professionnelle avec livraison des photos retouchées.';
      document.getElementById('event-duration').textContent = `${type.duration_hours}h`;
      document.getElementById('event-price').textContent = `Acompte ${deposit} €`;
    }

    // Load availability from API
async function loadAvailability() {
  if (!state.selectedType) return;
  
  setLoading(true);
  hideError();

  try {
    const response = await fetch(
      `${API_BASE}/get-availability?type=${state.selectedType.slug}&weeks=8`,
      {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        }
      }
    );
    const data = await response.json();

    if (data.error) throw new Error(data.error);

    state.slots = data.slots || [];
    renderCalendar();
  } catch (err) {
    showError("Impossible de charger les disponibilités.");
    console.error(err);
  } finally {
    setLoading(false);
  }
}

    // Render calendar
    function renderCalendar() {
      const year = state.currentMonth.getFullYear();
      const month = state.currentMonth.getMonth();

      const monthNames = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 
                          'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
      document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;

      const availableDates = new Set(state.slots.map(s => s.date));

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = (firstDay.getDay() + 6) % 7;

      const container = document.getElementById('calendar-days');
      container.innerHTML = '';

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Previous month
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        const btn = createDayButton(prevMonthLastDay - i, true, false, false);
        container.appendChild(btn);
      }

      // Current month
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        const dateStr = formatDateISO(date);
        const isAvailable = availableDates.has(dateStr);
        const isPast = date < today;
        const isToday = date.getTime() === today.getTime();
        const isSelected = state.selectedDate === dateStr;

        const btn = createDayButton(day, false, isAvailable && !isPast, isPast);
        btn.classList.toggle('today', isToday);
        btn.classList.toggle('selected', isSelected);
        if (isAvailable && !isPast) {
          btn.onclick = () => selectDate(dateStr);
        }
        container.appendChild(btn);
      }

      // Next month
      const totalCells = container.children.length;
      const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells;
      for (let day = 1; day <= remainingCells; day++) {
        const btn = createDayButton(day, true, false, false);
        container.appendChild(btn);
      }

      // Nav button state
      const minDate = new Date();
      document.getElementById('prev-month').disabled = 
        state.currentMonth <= new Date(minDate.getFullYear(), minDate.getMonth(), 1);

      renderSlots();
    }

    function createDayButton(day, isOtherMonth, isAvailable, isPast) {
      const btn = document.createElement('button');
      btn.className = 'calendar-day';
      btn.textContent = day;
      btn.type = 'button';
      if (isOtherMonth) btn.classList.add('other-month', 'disabled');
      if (isAvailable) btn.classList.add('available');
      if (isPast && !isOtherMonth) btn.classList.add('disabled');
      return btn;
    }

    function selectDate(dateStr) {
      state.selectedDate = dateStr;
      state.selectedSlot = null;
      renderCalendar();
    }

    // Render slots
    function renderSlots() {
      const container = document.getElementById('slots-content');

      if (!state.selectedDate) {
        container.innerHTML = '<div class="no-slots">Sélectionnez une date</div>';
        return;
      }

      const dateSlots = state.slots.filter(s => s.date === state.selectedDate);
      
      if (dateSlots.length === 0) {
        container.innerHTML = '<div class="no-slots">Aucun créneau disponible</div>';
        return;
      }

      const date = new Date(state.selectedDate);
      const options = { weekday: 'short', day: 'numeric', month: 'short' };
      const dateLabel = date.toLocaleDateString('fr-FR', options);

      let html = `<div class="slots-date">${dateLabel}</div><div class="slots-list">`;

      dateSlots.forEach(slot => {
        const isSelected = state.selectedSlot?.startTime === slot.startTime && 
                          state.selectedSlot?.date === slot.date;
        const label = getSlotLabel(slot);
        html += `
          <button type="button" class="slot-button ${isSelected ? 'selected' : ''}" 
                  onclick='selectSlot(${JSON.stringify(slot)})'>
            ${label}
          </button>
        `;
      });

      html += '</div>';

      if (state.selectedSlot) {
        html += `<button type="button" class="continue-btn" onclick="showFormView()">Continuer</button>`;
      }

      container.innerHTML = html;
    }

    function getSlotLabel(slot) {
      if (state.selectedType?.slug === 'journee') {
        return 'Journée (9h - 16h)';
      }
      return slot.startTime === '09:00' ? 'Matin (9h - 12h)' : 'Après-midi (13h - 16h)';
    }

    function selectSlot(slot) {
      state.selectedSlot = slot;
      renderSlots();
    }

    // View switching
    function showFormView() {
      if (!state.selectedSlot || !state.selectedType) return;

      const type = state.selectedType;
      const deposit = Math.round(type.price * (type.deposit_percent / 100));
      
      const date = new Date(state.selectedSlot.date);
      const dateStr = date.toLocaleDateString('fr-FR', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long' 
      });
      const timeStr = getSlotLabel(state.selectedSlot);

      document.getElementById('form-prestation').textContent = type.name;
      document.getElementById('form-datetime').textContent = `${dateStr}, ${timeStr}`;
      document.getElementById('summary-prestation').textContent = type.name;
      document.getElementById('summary-total').textContent = `${type.price} €`;
      document.getElementById('summary-deposit').textContent = `${deposit} €`;
      document.getElementById('submit-btn').textContent = `Payer ${deposit} €`;

      document.getElementById('calendar-view').classList.add('hidden');
      document.getElementById('form-view').classList.add('active');
    }

    function showCalendarView() {
      document.getElementById('form-view').classList.remove('active');
      document.getElementById('calendar-view').classList.remove('hidden');
    }

    // Submit form
    async function submitForm(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Chargement...';

      const payload = {
        prestationType: state.selectedType.slug,
        date: state.selectedSlot.date,
        startTime: state.selectedSlot.startTime,
        endTime: state.selectedSlot.endTime,
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
        postalCode: document.getElementById('postalCode').value.trim(),
        city: document.getElementById('city').value.trim(),
        notes: document.getElementById('notes').value.trim()
      };

      try {
        const response = await fetch(`${API_BASE}/create-booking`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.error) throw new Error(data.error);

        if (data.checkoutUrl) {
          window.location.href = data.checkoutUrl;
        }
      } catch (err) {
        showError(err.message || "Une erreur est survenue.");
        const deposit = Math.round(state.selectedType.price * (state.selectedType.deposit_percent / 100));
        submitBtn.disabled = false;
        submitBtn.textContent = `Payer ${deposit} €`;
      }
    }

    // Navigation
    function prevMonth() {
      state.currentMonth.setMonth(state.currentMonth.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      state.currentMonth.setMonth(state.currentMonth.getMonth() + 1);
      renderCalendar();
    }

    // Helpers
    function formatDateISO(date) {
      return date.toISOString().split('T')[0];
    }

    function setLoading(loading) {
      document.getElementById('loading').classList.toggle('hidden', !loading);
    }

    function showError(message) {
      const el = document.getElementById('error');
      document.getElementById('error-text').textContent = message;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('error').classList.add('hidden');
    }
  </script>
</body>
</html>
